if("function"!=typeof define)var define=require("amdefine")(module);define(["./Kit","./parse"],function(t,e){function n(t,e){if(e=e||"normal",E[t]&&E[t][e])return E[t][e];x.attr({"font-size":t,"font-weight":e});var n=x.getBBox();return E[t]=E[t]||{},E[t][e]={width:n.width/((x.attr("text").length-1)/2),height:n.height/2}}function r(t){x=t.text(-1e3,-1e3,"XgfTlM|.q\nXgfTlM|.q").attr({"font-family":k,"font-size":w})}function i(t,e,i){i.clear(),i.setSize(0,0),r(i),X=!!~e.indexOf("m");var s=d(t.tree);s.unshift(y("/",I.delimiter)),s.unshift(y("RegExp: ")),s.push(y("/",I.delimiter)),e&&s.push(y(e,I.flags));var u=n(w,"bold"),o=M,l=u.height/2+M,c=0,p=0;c=s.reduce(function(t,e){e.x=t,e.y=l;var n=e.text.length*u.width;return t+n},o),c+=M,p=u.height+2*M,s=i.add(s),i.setSize(c,u.height+2*M);var f=h(t.tree,0,0);p=Math.max(f.height+3*M+u.height,p),c=Math.max(f.width+2*M,c),i.setSize(c,p),a(f.items,M,2*M+u.height-f.y),i.add(f.items)}function h(t,e,n){return t.unshift({type:"startPoint"}),t.push({type:"endPoint"}),s(t,e,n)}function a(t,e,n){t.forEach(function(t){t._translate?t._translate(e,n):(t.x+=e,t.y+=n)})}function s(t,e,n){var r=[],i=[],h=0,a=0,s=e,u=n,o=n;if(!t.length)return O.empty(null,e,n);t.forEach(function(t){var e;e=t.repeat?O.repeat(t,s,n):O[t.type](t,s,n),r.push(e),s+=e.width+b,h+=e.width,u=Math.min(u,e.y),o=Math.max(o,e.y+e.height),i=i.concat(e.items)}),a=o-u,r.reduce(function(t,e){h+=b;var r=l(t.lineOutX,n,e.lineInX);return i.push(r),e});var c=r[0].lineInX,p=r[r.length-1].lineOutX;return{items:i,width:h,height:a,x:e,y:u,lineInX:c,lineOutX:p}}function u(e,r,i,h,a){e=t.toPrint(e);var s=6,u=n(w),o=e.length*u.width,l=u.height+2*s,c=o+2*s,p={type:"rect",x:r,y:i-l/2,width:c,height:l,stroke:"none",fill:h||"transparent"},f={type:"text",x:r+c/2,y:i,text:e,"font-size":w,"font-family":k,fill:a||"black"};return{text:f,rect:p,items:[p,f],width:c,height:l,x:r,y:p.y,lineInX:r,lineOutX:r+c}}function o(t,e,r,i){var h,a=n(v),s=r.split("\n"),u=s.length*a.height;h=s.length>1?Math.max.apply(Math,s.map(function(t){return t.length})):r.length,h*=a.width;var o=4,l={type:"text",x:t,y:e-u/2-o,text:r,"font-size":v,"font-family":k,fill:i||"#444"};return{label:l,x:t-h/2,y:e-u-o,width:h,height:u+o}}function l(t,e,n){return{type:"path",x:t,y:e,path:["M",t,e,"H",n],"stroke-linecap":"butt","stroke-linejoin":"round",stroke:"#333","stroke-width":2,_translate:function(t,e){var n=this.path;n[1]+=t,n[2]+=e,n[4]+=t}}}function c(t,e,n,r){var i,h,a=10,s=t>n?-1:1,u=e>r?-1:1;return Math.abs(e-r)<1.5*a?(i=["M",t,e,"C",t+Math.min(Math.abs(n-t)/2,a)*s,e,n-(n-t)/2,r,n,r],h=function(t,e){var n=this.path;n[1]+=t,n[2]+=e,n[4]+=t,n[5]+=e,n[6]+=t,n[7]+=e,n[8]+=t,n[9]+=e}):(i=["M",t,e,"Q",t+a*s,e,t+a*s,e+a*u,"V",Math.abs(e-r)<2*a?e+a*u:r-a*u,"Q",t+a*s,r,t+a*s*2,r,"H",n],h=function(t,e){var n=this.path;n[1]+=t,n[2]+=e,n[4]+=t,n[5]+=e,n[6]+=t,n[7]+=e,n[9]+=e,n[11]+=t,n[12]+=e,n[13]+=t,n[14]+=e,n[16]+=t}),{type:"path",path:i,"stroke-linecap":"butt","stroke-linejoin":"round",stroke:"#333","stroke-width":2,_translate:h}}function p(t,e,n){var r=10;return{items:[{type:"circle",fill:n,cx:t+r,cy:e,r:r,stroke:"none",_translate:function(t,e){this.cx+=t,this.cy+=e}}],width:2*r,height:2*r,x:t,y:e,lineInX:t,lineOutX:t+2*r}}function f(t){if(Array.isArray(t)){for(var e=t,n=0;n<e.length;n++)if(!f(e[n]))return!1;return!0}var r=t;return r.type===EMPTY_NODE?!0:r.type===GROUP_NODE&&void 0===r.num?f(r.sub):r.type===CHOICE_NODE?f(r.branches):void 0}function d(e){var n=[];return e.forEach(function(e){if(e.sub)n.push(y("(")),e.type===ASSERT_NODE?n.push(e.assertionType===AssertLookahead?y("?="):y("?!")):e.nonCapture&&n.push(y("?:")),n=n.concat(d(e.sub)),n.push(y(")"));else if(e.branches)e.branches.map(d).forEach(function(t){n=n.concat(t),n.push(y("|"))}),n.pop();else{var r=I[e.type]||I.defaults;switch(e.type){case CHARSET_NODE:var i=m(e);(!i||e.exclude)&&n.push(y("[")),e.exclude&&n.push(y("^",I.charsetExclude)),e.ranges.forEach(function(t){n.push(y(g(t[0]+"-"+t[1]),I.charsetRange))}),e.classes.forEach(function(t){n.push(y("\\"+t,I.charsetClass))}),n.push(y(g(e.chars),I.charsetChars)),(!i||e.exclude)&&n.push(y("]"));break;default:var h=e.raw||"";e.repeat&&(h=h.slice(0,e.repeat.beginIndex)),h=t.toPrint(h,!0),n.push(y(h,r))}}if(e.repeat){var a=e.repeat.min,s=e.repeat.max;0===a&&1/0===s?n.push(y("*")):1===a&&1/0===s?n.push(y("+")):0===a&&1===s?n.push(y("?")):(n.push(y("{")),n.push(y(a)),a===s?n.push(y("}")):(n.push(y(",")),isFinite(s)&&n.push(y(s)),n.push(y("}")))),e.repeat.nonGreedy&&n.push(y("?",I.repeatNonGreedy))}}),n}function g(e){return e=t.toPrint(e),e.replace(/\[/g,"\\[").replace(/\]/g,"\\]")}function y(t,e){return e=e||I[t]||I.defaults,{type:"text","font-size":w,"font-family":k,text:t+"",fill:e,"text-anchor":"start","font-weight":"bold"}}function m(t){return!t.chars&&!t.ranges.length&&1===t.classes.length}e.exportConstants();var x,w=16,v=14,b=16,k="DejaVu Sans Mono,monospace",X=!1,M=10,E={},O={startPoint:function(t,e,n){return p(e,n,"r(0.5,0.5)#EFE-green")},endPoint:function(t,e,n){return p(e,n,"r(0.5,0.5)#FFF-#000")},empty:function(t,e,n){var r=10,i=l(e,n,e+r);return{items:[i],width:r,height:2,x:e,y:n,lineInX:e,lineOutX:e+r}},exact:function(t,e,n){var r="skyblue";return u(t.chars,e,n,r)},dot:function(t,e,n){var r="DarkGreen",i="white",h=u("AnyCharExceptNewLine",e,n,r,i);return h.rect.r=10,h.rect.tip="AnyChar except CR LF",h},backref:function(t,e,n){var r="navy",i="white",h=u("Backref #"+t.num,e,n,r,i);return h.rect.r=8,h},repeat:function(t,e,n){function r(t){return t+(2>t?" time":" times")}function i(t,e){var n=this.path;n[1]+=t,n[2]+=e,n[4]+=t,n[5]+=e,n[6]+=t,n[7]+=e,n[9]+=e,n[11]+=t,n[12]+=e,n[13]+=t,n[14]+=e,n[16]+=t,n[18]+=t,n[19]+=e,n[20]+=t,n[21]+=e,n[23]+=e,n[25]+=t,n[26]+=e,n[27]+=t,n[28]+=e}if(f(t))return O.empty(null,e,n);var h=10,s=4,u=t.repeat,l="",c=[],p="darkgreen";if(u.min===u.max&&0===u.min)return O.empty(null,e,n);var d=O[t.type](t,e,n),g=d.width,y=d.height;if(u.min===u.max&&1===u.min)return d;u.min===u.max?l+=r(u.min):(l+=u.min,l+=isFinite(u.max)?(u.max-u.min>1?" to ":" or ")+r(u.max):" or more times");var m=h,x=0,w=h,v=d.y+d.height-n,b=2*h+d.width;g=b;var k;1!==u.max?(v+=h,y+=h,k={type:"path",path:["M",d.x+h,n,"Q",e,n,e,n+w,"V",n+v-w,"Q",e,n+v,e+w,n+v,"H",e+b-w,"Q",e+b,n+v,e+b,n+v-w,"V",n+w,"Q",e+b,n,d.x+d.width+h,n],_translate:i,stroke:"maroon","stroke-width":2},u.nonGreedy&&(k.stroke="Brown",k["stroke-dasharray"]="-"),c.push(k)):l=!1;var X;if(0===u.min){var M=n-d.y+h,E=b+2*h;m+=h,x=-h-2,g=E,y+=h,X={type:"path",path:["M",e,n,"Q",e+w,n,e+w,n-w,"V",n-M+w,"Q",e+w,n-M,e+2*w,n-M,"H",e+E-2*w,"Q",e+E-w,n-M,e+E-w,n-M+w,"V",n-w,"Q",e+E-w,n,e+E,n],_translate:i,stroke:u.nonGreedy?p:"#333","stroke-width":2},k&&a([k],h,0),c.push(X)}if(l){var I=o(e+g/2,n,l);a([I.label],0,v+I.height+s),c.push(I.label),y+=s+I.height;var A=(Math.max(I.width,g)-g)/2;A&&a(c,A,0),g=Math.max(I.width,g),m+=A}return a(d.items,m,0),c=c.concat(d.items),{items:c,width:g,height:y,x:e,y:d.y+x,lineInX:d.lineInX+m,lineOutX:d.lineOutX+m}},choice:function(t,e,n){if(f(t))return O.empty(null,e,n);var r=20,i=6,h=4,u=0,o=0,p=t.branches.map(function(t){var r=s(t,e,n);return u+=r.height,o=Math.max(o,r.width),r});u+=(p.length-1)*i+2*h,o+=2*r;var d=e+o/2,g=n-u/2+h,y=e+o,m=[];return p.forEach(function(t){var h=d-t.width/2;a(t.items,h-t.x,g-t.y),m=m.concat(t.items);var s=n+g-t.y,u=c(e,n,e+r,s),p=c(y,n,e+o-r,s);m.push(u,p),e+r!==h-t.x+t.lineInX&&m.push(l(e+r,s,h-t.x+t.lineInX)),t.lineOutX+h-t.x!==e+o-r&&m.push(l(t.lineOutX+h-t.x,s,e+o-r)),t.x=h,t.y=g,g+=t.height+i}),{items:m,width:o,height:u,x:e,y:n-u/2,lineInX:e,lineOutX:y}},charset:function(t,e,n){var r=6,i=4,h={d:"Digit",D:"NonDigit",w:"Word",W:"NonWord",s:"WhiteSpace",S:"NonWhiteSpace"},s="LightSkyBlue",l="black",c="Green",p="white",f="teal",d="white",g=t.exclude?"Pink":"Khaki",y=t.exclude?"#C00":"",x=m(t);if(x){var w=u(h[t.classes[0]],e,n,c,p);if(w.rect.r=5,t.exclude){var v=o(w.x+w.width/2,w.y,"None of:",y),b=w.items;b.push(v.label);var k=w.width,X=Math.max(v.width,w.width),M=(X-k)/2;return a(b,M,0),{items:b,width:X,height:w.height+v.height,x:Math.min(v.x,w.x),y:v.y,lineInX:M+w.x,lineOutX:M+w.x+w.width}}return w}if(!t.chars&&!t.ranges.length&&!t.classes.length){var w=u("AnyChar",e,n,"green","white");return w.rect.r=5,w}var E,O,I=[],X=0,A=0;t.chars&&(E=u(t.chars,e,n,s,l),E.rect.r=5,I.push(E),X=E.width),t.ranges.forEach(function(t){t=t.split("").join("-");var r=u(t,e,n,f,d);r.rect.r=5,I.push(r),X=Math.max(r.width,X)}),t.classes.forEach(function(t){var r=u(h[t],e,n,c,p);r.rect.r=5,I.push(r),X=Math.max(r.width,X)}),O=I[0].height;var C=[],N=[];I.sort(function(t,e){return e.width-t.width}),I.forEach(function(t){2*t.width+i>X?C.push(t):N.push(t)}),I=C;for(var F,_;N.length;){if(F=N.pop(),_=N.pop(),!_){I.push(F);break}F.width-_.width>2?(I.push(F),N.push(_)):(a(_.items,F.width+i,0),I.push({items:F.items.concat(_.items),width:F.width+_.width+i,height:F.height,x:F.x,y:F.y}),A-=F.height)}X+=2*r,A=(I.length-1)*i+I.length*O+2*r;var B={type:"rect",x:e,y:n-A/2,r:4,width:X,height:A,stroke:"none",fill:g},P=B.y+r,b=[B];I.forEach(function(t){a(t.items,e-t.x+(X-t.width)/2,P-t.y),b=b.concat(t.items),P+=t.height+i});var v=o(B.x+B.width/2,B.y,(t.exclude?"None":"One")+" of:",y);b.push(v.label);var k=X;X=Math.max(v.width,X);var M=(X-k)/2;return a(b,M,0),{items:b,width:X,height:A+v.height,x:Math.min(v.x,e),y:v.y,lineInX:M+e,lineOutX:M+e+B.width}},group:function(t,e,n){if(f(t))return O.empty(null,e,n);var r=10,i="silver",h=2,u=s(t.sub,e,n);if(t.num){a(u.items,r,0);var l=u.width+2*r,c=u.height+2*r,p={type:"rect",x:e,y:u.y-r,r:6,width:l,height:c,"stroke-dasharray":".",stroke:i,"stroke-width":h},d=o(p.x+p.width/2,p.y-h,"Group #"+t.num),g=u.items.concat([p,d.label]),y=Math.max(d.width,l),m=(y-l)/2;return m&&a(g,m,0),{items:g,width:y,height:c+d.height+4,x:e,y:d.y,lineInX:m+u.lineInX+r,lineOutX:m+u.lineOutX+r}}return u},assert:function(t,e,n){var r,i={AssertNonWordBoundary:{bg:"maroon",fg:"white"},AssertWordBoundary:{bg:"purple",fg:"white"},AssertEnd:{bg:"Indigo",fg:"white"},AssertBegin:{bg:"Indigo",fg:"white"}},h=t.assertionType,s=h.replace("Assert","")+"!";if(r=i[h])return!X||"AssertBegin"!==h&&"AssertEnd"!==h||(s="Line"+s),u(s,e,n,r.bg,r.fg);var l,c,p=8;h===AssertLookahead?(l="CornflowerBlue",c="darkgreen",s="Followed by:"):h===AssertNegativeLookahead&&(l="#F63",c="Purple",s="Not followed by:");var f=O.group(t,e,n),d=f.height+2*p,g=f.width+2*p,y={type:"rect",x:e,y:f.y-p,r:6,width:g,height:d,"stroke-dasharray":"-",stroke:l,"stroke-width":2},m=o(y.x+g/2,y.y,s,c),x=Math.max(g,m.width),w=(x-g)/2;a(f.items,w+p,0),w&&a([y,m.label],w,0);var v=f.items.concat([y,m.label]);return{items:v,width:x,height:y.height+m.height,x:e,y:m.y,lineInX:w+f.lineInX+p,lineOutX:w+f.lineOutX+p}}},I={delimiter:"Indigo",flags:"darkgreen",exact:"#334",dot:"darkblue",backref:"teal",$:"purple","^":"purple","\\b":"#F30","\\B":"#F30","(":"blue",")":"blue","?=":"darkgreen","?!":"red","?:":"grey","[":"navy","]":"navy","|":"blue","{":"maroon",",":"maroon","}":"maroon","*":"maroon","+":"maroon","?":"maroon",repeatNonGreedy:"#F61",defaults:"black",charsetRange:"olive",charsetClass:"navy",charsetExclude:"red",charsetChars:"#534"};return i});