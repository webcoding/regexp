if("function"!=typeof define)var define=require("amdefine")(module);define(["./Kit","./parse"],function(t,e){function n(t,e){if(e=e||"normal",M[t]&&M[t][e])return M[t][e];m.attr({"font-size":t,"font-weight":e});var n=m.getBBox();return M[t]=M[t]||{},M[t][e]={width:n.width/((m.attr("text").length-1)/2),height:n.height/2}}function r(t){m=t.text(-1e3,-1e3,"XgfTlM|.q\nXgfTlM|.q").attr({"font-family":k,"font-size":x})}function i(t,e,i){i.clear(),i.setSize(0,0),r(i),b=!!~e.indexOf("m");var s=d(t.tree);s.unshift(g("/",I.delimiter)),s.unshift(g("RegExp: ")),s.push(g("/",I.delimiter)),e&&s.push(g(e,I.flags));var o=n(x,"bold"),u=X,l=o.height/2+X,c=0,p=0;c=s.reduce(function(t,e){e.x=t,e.y=l;var n=e.text.length*o.width;return t+n},u),c+=X,p=o.height+2*X,s=i.add(s),i.setSize(c,o.height+2*X);var f=h(t.tree,0,0);p=Math.max(f.height+3*X+o.height,p),c=Math.max(f.width+2*X,c),i.setSize(c,p),a(f.items,X,2*X+o.height-f.y),i.add(f.items)}function h(t,e,n){return t.unshift({type:"startPoint"}),t.push({type:"endPoint"}),s(t,e,n)}function a(t,e,n){t.forEach(function(t){t._translate?t._translate(e,n):(t.x+=e,t.y+=n)})}function s(t,e,n){var r=[],i=[],h=0,a=0,s=e,o=n,u=n;if(!t.length)return E.empty(null,e,n);t.forEach(function(t){var e;e=t.repeat?E.repeat(t,s,n):E[t.type](t,s,n),r.push(e),s+=e.width+v,h+=e.width,o=Math.min(o,e.y),u=Math.max(u,e.y+e.height),i=i.concat(e.items)}),a=u-o,r.reduce(function(t,e){h+=v;var r=l(t.lineOutX,n,e.lineInX);return i.push(r),e});var c=r[0].lineInX,p=r[r.length-1].lineOutX;return{items:i,width:h,height:a,x:e,y:o,lineInX:c,lineOutX:p}}function o(e,r,i,h,a){e=t.toPrint(e);var s=6,o=n(x),u=e.length*o.width,l=o.height+2*s,c=u+2*s,p={type:"rect",x:r,y:i-l/2,width:c,height:l,stroke:"none",fill:h||"transparent"},d={type:"text",x:r+c/2,y:i,text:e,"font-size":x,"font-family":k,fill:a||"black"};return{text:d,rect:p,items:[p,d],width:c,height:l,x:r,y:p.y,lineInX:r,lineOutX:r+c}}function u(t,e,r,i){var h,a=n(w),s=r.split("\n"),o=s.length*a.height;h=s.length>1?Math.max.apply(Math,s.map(function(t){return t.length})):r.length,h*=a.width;var u=4,l={type:"text",x:t,y:e-o/2-u,text:r,"font-size":w,"font-family":k,fill:i||"#444"};return{label:l,x:t-h/2,y:e-o-u,width:h,height:o+u}}function l(t,e,n){return{type:"path",x:t,y:e,path:["M",t,e,"H",n],"stroke-linecap":"butt","stroke-linejoin":"round",stroke:"#333","stroke-width":2,_translate:function(t,e){var n=this.path;n[1]+=t,n[2]+=e,n[4]+=t}}}function c(t,e,n,r){var i,h,a=10,s=t>n?-1:1,o=e>r?-1:1;return Math.abs(e-r)<1.5*a?(i=["M",t,e,"C",t+Math.min(Math.abs(n-t)/2,a)*s,e,n-(n-t)/2,r,n,r],h=function(t,e){var n=this.path;n[1]+=t,n[2]+=e,n[4]+=t,n[5]+=e,n[6]+=t,n[7]+=e,n[8]+=t,n[9]+=e}):(i=["M",t,e,"Q",t+a*s,e,t+a*s,e+a*o,"V",Math.abs(e-r)<2*a?e+a*o:r-a*o,"Q",t+a*s,r,t+a*s*2,r,"H",n],h=function(t,e){var n=this.path;n[1]+=t,n[2]+=e,n[4]+=t,n[5]+=e,n[6]+=t,n[7]+=e,n[9]+=e,n[11]+=t,n[12]+=e,n[13]+=t,n[14]+=e,n[16]+=t}),{type:"path",path:i,"stroke-linecap":"butt","stroke-linejoin":"round",stroke:"#333","stroke-width":2,_translate:h}}function p(t,e,n){var r=10;return{items:[{type:"circle",fill:n,cx:t+r,cy:e,r:r,stroke:"none",_translate:function(t,e){this.cx+=t,this.cy+=e}}],width:2*r,height:2*r,x:t,y:e,lineInX:t,lineOutX:t+2*r}}function d(e){var n=[];return e.forEach(function(e){if(e.sub)n.push(g("(")),e.type===ASSERT_NODE?n.push(e.assertionType===AssertLookahead?g("?="):g("?!")):e.nonCapture&&n.push(g("?:")),n=n.concat(d(e.sub)),n.push(g(")"));else if(e.branches)e.branches.map(d).forEach(function(t){n=n.concat(t),n.push(g("|"))}),n.pop();else{var r=I[e.type]||I.defaults;switch(e.type){case CHARSET_NODE:var i=y(e);(!i||e.exclude)&&n.push(g("[")),e.exclude&&n.push(g("^",I.charsetExclude)),e.ranges.forEach(function(t){n.push(g(f(t[0]+"-"+t[1]),I.charsetRange))}),e.classes.forEach(function(t){n.push(g("\\"+t,I.charsetClass))}),n.push(g(f(e.chars),I.charsetChars)),(!i||e.exclude)&&n.push(g("]"));break;default:var h=e.raw||"";e.repeat&&(h=h.slice(0,e.repeat.beginIndex)),h=t.toPrint(h,!0),n.push(g(h,r))}}if(e.repeat){var a=e.repeat.min,s=e.repeat.max;0===a&&1/0===s?n.push(g("*")):1===a&&1/0===s?n.push(g("+")):0===a&&1===s?n.push(g("?")):(n.push(g("{")),n.push(g(a)),a===s?n.push(g("}")):(n.push(g(",")),isFinite(s)&&n.push(g(s)),n.push(g("}")))),e.repeat.nonGreedy&&n.push(g("?",I.repeatNonGreedy))}}),n}function f(e){return e=t.toPrint(e),e.replace(/\[/g,"\\[").replace(/\]/g,"\\]")}function g(t,e){return e=e||I[t]||I.defaults,{type:"text","font-size":x,"font-family":k,text:t+"",fill:e,"text-anchor":"start","font-weight":"bold"}}function y(t){return!t.chars&&!t.ranges.length&&1===t.classes.length}e.exportConstants();var m,x=16,w=14,v=16,k="DejaVu Sans Mono,monospace",b=!1,X=10,M={},E={startPoint:function(t,e,n){return p(e,n,"r(0.5,0.5)#EFE-green")},endPoint:function(t,e,n){return p(e,n,"r(0.5,0.5)#FFF-#000")},empty:function(t,e,n){var r=6,i=l(e,n,e+r);return{items:[i],width:r,height:2,x:e,y:n,lineInX:e,lineOutX:e+r}},exact:function(t,e,n){var r="skyblue";return o(t.chars,e,n,r)},dot:function(t,e,n){var r="DarkGreen",i="white",h=o("AnyCharExceptNewLine",e,n,r,i);return h.rect.r=10,h.rect.tip="Any char except CR LF.",h},backref:function(t,e,n){var r="navy",i="white",h=o("Backref group #"+t.num,e,n,r,i);return h.rect.r=8,h},repeat:function(t,e,n){function r(t){return t+(2>t?" time":" times")}function i(t,e){var n=this.path;n[1]+=t,n[2]+=e,n[4]+=t,n[5]+=e,n[6]+=t,n[7]+=e,n[9]+=e,n[11]+=t,n[12]+=e,n[13]+=t,n[14]+=e,n[16]+=t,n[18]+=t,n[19]+=e,n[20]+=t,n[21]+=e,n[23]+=e,n[25]+=t,n[26]+=e,n[27]+=t,n[28]+=e}var h=10,s=4,o=t.repeat,l="",c=[],p="darkgreen";if(o.min===o.max&&0===o.min)return E.empty(null,e,n);var d=E[t.type](t,e,n),f=d.width,g=d.height;if(o.min===o.max&&1===o.min)return d;o.min===o.max?l+=r(o.min):(l+=o.min,l+=isFinite(o.max)?(o.max-o.min>1?" to ":" or ")+r(o.max):" or more times");var y=h,m=0,x=h,w=d.y+d.height-n,v=2*h+d.width;f=v;var k;1!==o.max?(w+=h,g+=h,k={type:"path",path:["M",d.x+h,n,"Q",e,n,e,n+x,"V",n+w-x,"Q",e,n+w,e+x,n+w,"H",e+v-x,"Q",e+v,n+w,e+v,n+w-x,"V",n+x,"Q",e+v,n,d.x+d.width+h,n],_translate:i,stroke:"maroon","stroke-width":2},o.nonGreedy&&(k.stroke="Brown",k["stroke-dasharray"]="-"),c.push(k)):l=!1;var b;if(0===o.min){var X=n-d.y+h,M=v+2*h;y+=h,m=-h-2,f=M,g+=h,b={type:"path",path:["M",e,n,"Q",e+x,n,e+x,n-x,"V",n-X+x,"Q",e+x,n-X,e+2*x,n-X,"H",e+M-2*x,"Q",e+M-x,n-X,e+M-x,n-X+x,"V",n-x,"Q",e+M-x,n,e+M,n],_translate:i,stroke:o.nonGreedy?p:"#333","stroke-width":2},k&&a([k],h,0),c.push(b)}if(l){var I=u(e+f/2,n,l);a([I.label],0,w+I.height+s),c.push(I.label),g+=s+I.height;var O=(Math.max(I.width,f)-f)/2;O&&a(c,O,0),f=Math.max(I.width,f),y+=O}return a(d.items,y,0),c=c.concat(d.items),{items:c,width:f,height:g,x:e,y:d.y+m,lineInX:d.lineInX+y,lineOutX:d.lineOutX+y}},choice:function(t,e,n){var r=20,i=6,h=4,o=0,u=0,p=t.branches.map(function(t){var r=s(t,e,n);return o+=r.height,u=Math.max(u,r.width),r});o+=(p.length-1)*i+2*h,u+=2*r;var d=e+u/2,f=n-o/2+h,g=e+u,y=[];return p.forEach(function(t){var h=d-t.width/2;a(t.items,h-t.x,f-t.y),y=y.concat(t.items);var s=n+f-t.y,o=c(e,n,e+r,s),p=c(g,n,e+u-r,s);y.push(o,p),e+r!==h-t.x+t.lineInX&&y.push(l(e+r,s,h-t.x+t.lineInX)),t.lineOutX+h-t.x!==e+u-r&&y.push(l(t.lineOutX+h-t.x,s,e+u-r)),t.x=h,t.y=f,f+=t.height+i}),{items:y,width:u,height:o,x:e,y:n-o/2,lineInX:e,lineOutX:g}},charset:function(t,e,n){var r=6,i=4,h={d:"Digit",D:"NonDigit",w:"Word",W:"NonWord",s:"WhiteSpace",S:"NonWhiteSpace"},s="LightSkyBlue",l="black",c="Green",p="white",d="teal",f="white",g=t.exclude?"Pink":"Khaki",m=t.exclude?"#C00":"",x=y(t);if(x){var w=o(h[t.classes[0]],e,n,c,p);if(w.rect.r=5,t.exclude){var v=u(w.x+w.width/2,w.y,"None of:",m),k=w.items;k.push(v.label);var b=w.width,X=Math.max(v.width,w.width),M=(X-b)/2;return a(k,M,0),{items:k,width:X,height:w.height+v.height,x:Math.min(v.x,w.x),y:v.y,lineInX:M+w.x,lineOutX:M+w.x+w.width}}return w}if(!t.chars&&!t.ranges.length&&!t.classes.length){var w=o("AnyChar",e,n,"green","white");return w.rect.r=5,w}var E,I,O=[],X=0,A=0;t.chars&&(E=o(t.chars,e,n,s,l),E.rect.r=5,O.push(E),X=E.width),t.ranges.forEach(function(t){t=t.split("").join("-");var r=o(t,e,n,d,f);r.rect.r=5,O.push(r),X=Math.max(r.width,X)}),t.classes.forEach(function(t){var r=o(h[t],e,n,c,p);r.rect.r=5,O.push(r),X=Math.max(r.width,X)}),I=O[0].height;var C=[],N=[];O.sort(function(t,e){return e.width-t.width}),O.forEach(function(t){2*t.width+i>X?C.push(t):N.push(t)}),O=C;for(var B,F;N.length;){if(B=N.pop(),F=N.pop(),!F){O.push(B);break}B.width-F.width>2?(O.push(B),N.push(F)):(a(F.items,B.width+i,0),O.push({items:B.items.concat(F.items),width:B.width+F.width+i,height:B.height,x:B.x,y:B.y}),A-=B.height)}X+=2*r,A=(O.length-1)*i+O.length*I+2*r;var S={type:"rect",x:e,y:n-A/2,r:4,width:X,height:A,stroke:"none",fill:g},Q=S.y+r,k=[S];O.forEach(function(t){a(t.items,e-t.x+(X-t.width)/2,Q-t.y),k=k.concat(t.items),Q+=t.height+i});var v=u(S.x+S.width/2,S.y,(t.exclude?"None":"One")+" of:",m);k.push(v.label);var b=X;X=Math.max(v.width,X);var M=(X-b)/2;return a(k,M,0),{items:k,width:X,height:A+v.height,x:Math.min(v.x,e),y:v.y,lineInX:M+e,lineOutX:M+e+S.width}},group:function(t,e,n){var r=10,i="silver",h=2,o=s(t.sub,e,n);if(t.num){a(o.items,r,0);var l=o.width+2*r,c=o.height+2*r,p={type:"rect",x:e,y:o.y-r,r:6,width:l,height:c,"stroke-dasharray":".",stroke:i,"stroke-width":h},d=u(p.x+p.width/2,p.y-h,"Group #"+t.num),f=o.items.concat([p,d.label]),g=Math.max(d.width,l),y=(g-l)/2;return y&&a(f,y,0),{items:f,width:g,height:c+d.height,x:e,y:d.y,lineInX:y+o.lineInX+r,lineOutX:y+o.lineOutX+r}}return o},assert:function(t,e,n){var r,i={AssertNonWordBoundary:{bg:"maroon",fg:"white"},AssertWordBoundary:{bg:"purple",fg:"white"},AssertEnd:{bg:"Indigo",fg:"white"},AssertBegin:{bg:"Indigo",fg:"white"}},h=t.assertionType,s=h.replace("Assert","")+"!";if(r=i[h])return!b||"AssertBegin"!==h&&"AssertEnd"!==h||(s="Line"+s),o(s,e,n,r.bg,r.fg);var l,c,p=8;h===AssertLookahead?(l="CornflowerBlue",c="darkgreen",s="If followed by:"):h===AssertNegativeLookahead&&(l="#F63",c="Purple",s="If not followed by:");var d=E.group(t,e,n),f=d.height+2*p,g=d.width+2*p,y={type:"rect",x:e,y:d.y-p,r:6,width:g,height:f,"stroke-dasharray":"-",stroke:l,"stroke-width":2},m=u(y.x+g/2,y.y,s,c),x=Math.max(g,m.width),w=(x-g)/2;a(d.items,w+p,0),w&&a([y,m.label],w,0);var v=d.items.concat([y,m.label]);return{items:v,width:x,height:y.height+m.height,x:e,y:m.y,lineInX:w+d.lineInX+p,lineOutX:w+d.lineOutX+p}}},I={delimiter:"Indigo",flags:"darkgreen",exact:"#334",dot:"darkblue",backref:"teal",$:"purple","^":"purple","\\b":"#F30","\\B":"#F30","(":"blue",")":"blue","?=":"darkgreen","?!":"red","?:":"grey","[":"navy","]":"navy","|":"blue","{":"maroon",",":"maroon","}":"maroon","*":"maroon","+":"maroon","?":"maroon",repeatNonGreedy:"#F61",defaults:"black",charsetRange:"olive",charsetClass:"navy",charsetExclude:"red",charsetChars:"#534"};return i});