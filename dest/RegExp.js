if("function"!=typeof define)var define=require("amdefine")(module);define(["./parse","./Kit","./NFA"],function(t,n,e){function r(n,e){if(!(this instanceof r))return new r(n,e);n+="";var c={};"string"==typeof e?(e=e.toLowerCase(),~e.indexOf("i")&&(c.ignoreCase=!0),~e.indexOf("m")&&(c.multiline=!0),~e.indexOf("g")&&(c.global=!0),~e.indexOf("d")&&(c.debug=!0)):c=e;var o=this.ast=t(n);this.source=n,this.multiline=!!c.multiline,this.global=!!c.global,this.ignoreCase=!!c.ignoreCase,this.debug=!!c.debug,this.flags="",this.multiline&&(this.flags+="m"),this.ignoreCase&&(this.flags+="i"),this.global&&(this.flags+="g"),h(this,["source","options","multiline","global","ignoreCase","flags","debug"]);var u=this.ignoreCase;o.traverse(function(t){i(t,u)},CHARSET_NODE),o.traverse(function(t){a(t,u)},EXACT_NODE),this.multiline&&o.traverse(s,ASSERT_NODE)}function a(t,n){var e;e=t.chars.split(""),e=e.map(n?function(t){return/[a-z]/.test(t)?[t,t.toUpperCase()]:/[A-Z]/.test(t)?[t,t.toLowerCase()]:[t]}:function(t){return[t]}),t.explained=e}function s(t){var n=t.assertionType;(n===AssertBegin||n===AssertEnd)&&(t.multiline=!0)}function i(t,e){var r=t.chars.split("");r=r.concat(n.flatten2(t.classes.map(function(t){return g[t]}))),r=r.concat(t.ranges),e&&(r=c(r)),r=n.classify(r).ranges,t.exclude&&(r=n.negate(r)),r=n.coalesce(r),t.explained=r}function c(t){return n.flatten2(t.map(function(t){var e=n.classify([t,"az","AZ"]).map[t];return n.flatten2(e.map(function(t){return/[a-z]/.test(t)?[t,t.toUpperCase()]:/[A-Z]/.test(t)?[t,t.toLowerCase()]:[t]}))}))}function o(t,n){var e,r=[];return n=n||["start"],e=t.reduce(function(t,n){var e=u(n,t);return r=r.concat(e.trans),e.accepts},n),{accepts:e,trans:r}}function u(t,n){return t.repeat?p(t,n):x[t.type](t,n)}function f(t,n,e){for(var r,a,s,i=0,c=t.length;c>i;i++)if(s=t[i],s.num===n)if(s.type===b)a=s.index;else if(s.type===m){r=s.index;break}return void 0!==r&&void 0!==a?e.slice(r,a):void 0}function l(){return"q"+v++}function p(t,n){var e,r,a=x[t.type],s=[],i=t.repeat,c=i.min,o=i.max;for(r=c;r--;)e=a(t,n),s=s.concat(e.trans),n=e.accepts;var u=[],f=[].concat(n);if(isFinite(o))for(;o>c;o--)e=a(t,n),u=u.concat(e.trans),n=e.accepts,f=f.concat(e.accepts);else{var p=n.slice();e=a(t,n),u=u.concat(e.trans),f=f.concat(e.accepts),u.push({from:e.accepts,to:p,charset:!1})}var h=[l()];return i.nonGreedy?(s.push({from:f,to:h,charset:!1}),s=s.concat(u)):(s=s.concat(u),s.push({from:f,to:h,charset:!1})),{accepts:h,trans:s}}function h(t,n){n.forEach(function(n){Object.defineProperty(t,n,{writable:!1,enumerable:!0})})}t.exportConstants(),r.DEBUG=r.D=1,r.MULTILINE=r.M=2,r.GLOBAL=r.G=4,r.IGNORECASE=r.I=8,r.prototype={toString:function(){return"/"+this.source+"/"+this.flags},test:function(t){return null!==this.exec(t)},exec:function(t){for(var n,e=this.getNFA(),r=this.global?this.lastIndex||0:0,a=t.length;a>r&&(n=e.input(t,r),!n.acceptable);r++);if(!n||!n.acceptable)return this.lastIndex=0,null;var s=new Array(this.ast.groupCount+1);s[0]=t.slice(r,n.lastIndex+1);for(var i=n.stack,c=1,o=s.length;o>c;c++)s[c]=f(i,c,t);return this.lastIndex=n.lastIndex+1,s.index=r,s.input=t,s},getNFA:function(){if(this._nfa)return this._nfa;var t,n=this.ast;return v=1,t=o(n.tree),t=e(t,this.debug),this._nfa=t,t}};var d=n.parseCharset("^\n\r\u2028\u2029"),g={d:["09"],w:["AZ","az","09","_"],s:" \f\n\r	 ᠎           \u2028\u2029  　".split("")};["d","w","s"].forEach(function(t){g[t.toUpperCase()]=n.negate(g[t])});var v=0,m="GroupCaptureStart",b="GroupCaptureEnd",x=function(){function t(t,n){var e,r=[],a=t.explained;return a.forEach(function(t){r.push({from:n,to:e=[l()],charset:t}),n=e}),{accepts:e,trans:r}}function n(t,n){var e=[l()];return{accepts:e,trans:[{from:n,to:e,charset:t.explained}]}}function r(t,n){var e=[l()];return{accepts:e,trans:[{from:n,to:e,charset:d}]}}function a(t,n){var e=[l()];return{accepts:e,trans:[{from:n,to:e,charset:!1}]}}function s(t,n){var e=[l()],r=[{from:n,to:e,charset:!1,action:!t.nonCapture&&function(n,e,r){n.unshift({type:m,num:t.num,index:r})}}];n=e;var a=o(t.sub,n);r=r.concat(a.trans);var s=[l()];return r.push({from:a.accepts,to:s,charset:!1,action:!t.nonCapture&&function(n,e,r){n.unshift({type:b,num:t.num,index:r})}}),{accepts:s,trans:r}}function i(t,n){var e=[l()],r=t.num;return{accepts:e,trans:[{from:n,to:e,charset:!1,assert:function(t,n,e,a,s){var i=f(t,r,s);return void 0===i&&(i=r),s.slice(e,e+i.length)===i?i.length:!1}}]}}function c(t,n){var e=[],r=[];return t.branches.forEach(function(t){var a=o(t,n);e=e.concat(a.trans),r=r.concat(a.accepts)}),{trans:e,accepts:r}}function u(t,n){function r(t,n,e){var r=[l()];return{accepts:r,trans:[{from:n,to:r,charset:!1,assert:e}]}}function a(t){var n=e(o(t.sub,["start"]));return function(t,e,r,a,s){var i=n.input(s,r,null,t);return i.acceptable}}function s(t){var n=a(t);return function(){return!n.apply(this,arguments)}}function i(t,n){return!!(c(t-1,n)^c(t,n))}function c(t,n){return-1!==t&&t!==n.length&&/\w/.test(n[t])}function u(t,n,e,r,a){return 0===e||"\n"===a[e-1]}function f(t,n,e){return 0===e}function p(t,n,e,r,a){return e===a.length||"\n"===n}function h(t,n,e,r,a){return e===a.length}var d;switch(t.assertionType){case AssertBegin:d=t.multiline?u:f;break;case AssertEnd:d=t.multiline?p:h;break;case AssertWordBoundary:d=function(t,n,e,r,a){return i(e,a)};break;case AssertNonWordBoundary:d=function(t,n,e,r,a){return!i(e,a)};break;case AssertLookahead:d=a(t);break;case AssertNegativeLookahead:d=s(t)}return r(t,n,d)}return{assert:u,choice:c,backref:i,group:s,empty:a,charset:n,dot:r,exact:t}}();return r});