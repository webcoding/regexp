if("function"!=typeof define)var define=require("amdefine")(module);define(["./Kit"],function(e){function t(t){t=t.compact?i(t):t;var s,c={},f=t.trans,u={};for(s=0,n=t.accepts.length;n>s;s++)c[t.accepts[s]]=!0;var h;for(s=0,n=f.length;n>s;s++)h=f[s],h.charset?h.ranges="string"==typeof h.charset?e.parseCharset(h.charset):h.charset:h.eMove=!0,h.from.forEach(function(e){var t=u[e]=u[e]||{eMoveStates:[],eMove:[],charMove:{},trans:[],ranges:[]};h.eMove?t.eMoveStates=t.eMoveStates.concat(h.to):t.ranges=t.ranges.concat(h.ranges),t.trans.push(h)});var v=Object.keys(u);return v.forEach(function(t){var r=u[t],n=r.trans,a=r.charMove,o=r.eMove,s=r.ranges,c=e.classify(s),i=c.map;n.forEach(function(t){t.eMove?t.to.forEach(function(e){o.push({to:e,action:t.action,assert:t.assert,eMove:!0})}):e.flatten2(t.ranges.map(function(e){return i[e]})).forEach(function(e){(a[e]=a[e]||[]).push(t)})}),s=e.Set(c.ranges.filter(function(e){return!!e[1]})),r.ranges=s,Object.keys(a).forEach(function(e){var t=a[e],r=[];n.forEach(function(e){e.to.forEach(function(n){(e.eMove||~t.indexOf(e))&&r.push({to:n,action:e.action,assert:e.assert,eMove:e.eMove})})}),a[e]=r}),delete r.trans,delete r.eMoveStates}),{accepts:c,router:u,input:o,assertDFA:a,accept:r}}function r(e){return this.accepts.hasOwnProperty(e)}function a(){for(var t,r=this.router,n=Object.keys(r),a=0,o=n.length;o>a;a++){if(t=r[n[a]],t.eMove.length>1)throw new Error("DFA Assertion Fail!\nFrom state `"+n[a]+"` can goto to multi ε-move states!");for(var s=t.charMove,c=Object.keys(s),i=0,f=c.length;f>i;i++){var u=s[c[i]];if(1!==u.length)throw e.log(s),new Error("DFA Assertion Fail!\nFrom state `"+n[a]+"` via charset `"+c[i]+"` can goto to multi states!")}if(c.length&&t.eMove.length)throw new Error("DFA Assertion Fail!\nFrom state `"+n[a]+"` can goto extra ε-move state!")}return!0}function o(t,r,n){function a(t,r,c,i,f){e:for(;;){var u,h,v,l,g=o.router[c];if(!g)break;var p,M=g.eMove,m=g.charMove;r<t.length?(u=t[r],p=m.hasOwnProperty(u)?m[u]:(h=s(g.ranges,u))?m[h]:M):p=M;for(var E,d,y,F=i.length,b=f,w=0,O=p.length;O>w;w++){if(E=p[w],v=E.eMove?0:1,f=b,i.splice(0,i.length-F),F=i.length,E.assert){if((d=E.assert(i,u,r,c,t))===!1)continue;"number"==typeof d&&(r+=d,f+=d)}if(E.action&&(i=E.action(i,u,r,c,t)||i),f=E.eMove?f:r,n&&e.log(u+":"+c+">"+E.to),w===O-1){r+=v,c=E.to;continue e}if(y=a(t,r+v,E.to,i,f),y.acceptable)return y;l=y}if(l)return l;break}return{stack:i,lastIndex:f,lastState:c,acceptable:o.accept(c)}}r=r||0;var o=this;return a(t,r,"start",[],r-1)}function s(e,t){var r=e.indexOf(t,c);return~r?e[r]:!1}function c(e,t){var r=t[0],n=t[1];return e>n?1:r>e?-1:0}function i(e){e.accepts=e.accepts.split(",");for(var t,r,n,a,o=e.trans,s=o.length;s--;)t=o[s],r=t[0].split(">"),n=r[0].split(","),a=r[1].split(","),o[s]={from:n,to:a,charset:t[1],action:t[2],assert:t[3]};return e.compact=!1,e}return t});