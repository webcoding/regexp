if("function"!=typeof define)var define=require("amdefine")(module);define(["./Kit"],function(e){function t(t,s){this._debug=s,t=t.compact?i(t):t;var c,f={},u=t.trans,h={};for(c=0,n=t.accepts.length;n>c;c++)f[t.accepts[c]]=!0;var v;for(c=0,n=u.length;n>c;c++)v=u[c],v.charset?v.ranges="string"==typeof v.charset?e.parseCharset(v.charset):v.charset:v.eMove=!0,v.from.forEach(function(e){var t=h[e]=h[e]||{eMoveStates:[],eMove:[],charMove:{},trans:[],ranges:[]};v.eMove?t.eMoveStates=t.eMoveStates.concat(v.to):t.ranges=t.ranges.concat(v.ranges),t.trans.push(v)});var l=Object.keys(h);return l.forEach(function(t){var r=h[t],n=r.trans,a=r.charMove,o=r.eMove,s=r.ranges,c=e.classify(s),i=c.map;n.forEach(function(t){t.eMove?t.to.forEach(function(e){o.push({to:e,action:t.action,assert:t.assert,eMove:!0})}):e.flatten2(t.ranges.map(function(e){return i[e]})).forEach(function(e){(a[e]=a[e]||[]).push(t)})}),s=e.Set(c.ranges.filter(function(e){return!!e[1]})),r.ranges=s,Object.keys(a).forEach(function(e){var t=a[e],r=[];n.forEach(function(e){e.to.forEach(function(n){(e.eMove||~t.indexOf(e))&&r.push({to:n,action:e.action,assert:e.assert,eMove:e.eMove})})}),a[e]=r}),delete r.trans,delete r.eMoveStates}),{accepts:f,router:h,input:o,assertDFA:a,accept:r}}function r(e){return this.accepts.hasOwnProperty(e)}function a(){for(var t,r=this.router,n=Object.keys(r),a=0,o=n.length;o>a;a++){if(t=r[n[a]],t.eMove.length>1)throw new Error("DFA Assertion Fail!\nFrom state `"+n[a]+"` can goto to multi ε-move states!");for(var s=t.charMove,c=Object.keys(s),i=0,f=c.length;f>i;i++){var u=s[c[i]];if(1!==u.length)throw e.log(s),new Error("DFA Assertion Fail!\nFrom state `"+n[a]+"` via charset `"+c[i]+"` can goto to multi states!")}if(c.length&&t.eMove.length)throw new Error("DFA Assertion Fail!\nFrom state `"+n[a]+"` can goto extra ε-move state!")}return!0}function o(t,r){function n(t,r,o,c,i){e:for(;;){var f,u,h,v,l=a.router[o];if(!l)break;var g,p=l.eMove,M=l.charMove;r<t.length?(f=t[r],g=M.hasOwnProperty(f)?M[f]:(u=s(l.ranges,f))?M[u]:p):g=p;for(var m,d,b,E=c.length,y=i,F=0,w=g.length;w>F;F++){if(m=g[F],h=m.eMove?0:1,i=y,c.splice(0,c.length-E),E=c.length,m.assert){if((d=m.assert(c,f,r,o,t))===!1)continue;"number"==typeof d&&(r+=d,i+=d)}if(m.action&&(c=m.action(c,f,r,o,t)||c),i=m.eMove?i:r,this._debug&&e.log(f+":"+o+">"+m.to),F===w-1){r+=h,o=m.to;continue e}if(b=n(t,r+h,m.to,c,i),b.acceptable)return b;v=b}if(v)return v;break}return{stack:c,lastIndex:i,lastState:o,acceptable:a.accept(o)}}r=r||0;var a=this;return n(t,r,"start",[],r-1)}function s(e,t){var r=e.indexOf(t,c);return~r?e[r]:!1}function c(e,t){var r=t[0],n=t[1];return e>n?1:r>e?-1:0}function i(e){e.accepts=e.accepts.split(",");for(var t,r,n,a,o=e.trans,s=o.length;s--;)t=o[s],r=t[0].split(">"),n=r[0].split(","),a=r[1].split(","),o[s]={from:n,to:a,charset:t[1],action:t[2],assert:t[3]};return e.compact=!1,e}return t});